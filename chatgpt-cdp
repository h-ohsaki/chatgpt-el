#!/usr/bin/env python3
#
#
# Copyright (c) 2025, Hiroyuki Ohsaki.
# All rights reserved.
#
# $Id: $
#

import os
import sys
import time
import itertools
import json
import requests
import websocket

from perlcompat import die, warn, getopts
import tbdump

def usage():
    die(f"""\
usage: {sys.argv[0]} [-v] [file...]
  -v    verbose mode
""")

id_counter = itertools.count(1)

def cdb_send(ws, method, params=None):
    id_ = next(id_counter)
    req = {'id': id_, 'method': method}
    if params:
        req['params'] = params
    ws.send(json.dumps(req))
    ws.settimeout(5)
    while True:
        resp = json.loads(ws.recv())
        if resp.get('id') == id_:
            return resp

def send_query(query):
    # Identify the first page.
    req = requests.get('http://127.0.0.1:9000/json/list', timeout=5)
    pages = [elem for elem in req.json() if elem.get('type') == 'page']
    page = pages[0]
    url = page.get('webSocketDebuggerUrl')

    # Create a WebScoket connection to the browser.
    ws = websocket.create_connection(url)
    # cdb_send(ws, 'Page.enable')

    # If not visiting chatgpt.com, visit the page first.
    if 'https://chatgpt.com' not in page.get('url'):
        cdb_send(ws, 'Page.navigate', {'url': 'https://chatgpt.com'})
        time.sleep(1)

    # Fill the textare with the query.
    js = f"document.querySelector('div#prompt-textarea').innerHTML = '{query}';"
    resp = cdb_send(ws, 'Runtime.evaluate', {'expression': js})

    # Click the submit button.
    js = "document.querySelector('button#composer-submit-button[data-testid=\"send-button\"]').click();"
    resp = cdb_send(ws, 'Runtime.evaluate', {'expression': js})

def recv_query():
    # Identify the first page.
    req = requests.get('http://127.0.0.1:9000/json/list', timeout=5)
    pages = [elem for elem in req.json() if elem.get('type') == 'page']
    page = pages[0]
    url = page.get('webSocketDebuggerUrl')

    # Create a WebScoket connection to the browser.
    ws = websocket.create_connection(url)

    # Wait until ''article > h6 + div' is visible.
    while True:
        js = """
    (function() {
        const el = document.querySelector('article > h6 + div');
        if (!el) return false;
        const style = window.getComputedStyle(el);
        return (style && style.display !== 'none' && style.visibility !== 'hidden' && el.innerHTML.trim().length > 0);
    })()
    """
        resp = cdb_send(ws, 'Runtime.evaluate', {'expression': js})
        if resp['result']['result']['value']:
            break
        time.sleep(0.5)

    # Dump the inner-html of the last 'article > h6 + div'
    # js = "document.querySelector('article > h6 + div').innerHTML"
    js = "Array.from(document.querySelectorAll('article > h6 + div')).slice(-1)[0].innerHTML"
    resp = cdb_send(ws, 'Runtime.evaluate', {'expression': js})
    content = resp['result']['result']['value']
    print(content)

def main():
    opt = getopts('e:s:r') or usage()
    if opt.s:
        query = opt.s
        send_query(query)
    if opt.r:
        time.sleep(1)
        print(recv_query())

if __name__ == "__main__":
    main()
"""
    # ページ全体の HTML を取得する
    resp = cdb_send(ws, 'Runtime.evaluate',
                    {'expression': 'document.documentElement.outerHTML'})
    html = resp['result']['result']['value']
    time.sleep(1)
    html_after = resp['result']['result']['value']

"""
